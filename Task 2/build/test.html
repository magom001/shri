<!doctype html>

<html lang="ru">

<head>
    <meta charset="utf-8">

    <title>ШРИ Задание № 2</title>
    <meta name="description" content="Yandex Academy Frontend School">
    <meta name="author" content="Arkady Magomedov">

    <link rel="stylesheet" href="css/main.css?v=1.0">

    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <![endif]-->

    <style>
        .modal {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background-color: black;
            opacity: .7;
            z-index: 999999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-opened {
            filter: blur(2px);
        }

        .content {
            padding: 30px 60px;
            border-radius: 30px;
            background-color: #fff;
        }
    </style>
</head>

<body>
    <!-- <div class="modal">
        <div class="content">
            <h1>Hello World!</h1>
        </div>
    </div> -->
    <!-- <div class="modal-opened"> -->
    <div>
        <svg id="svg" width="600" height="600" viewBox="0 0 500 500">
            <style>
                text {
                    font: 100px Verdana, Helvetica, Arial, sans-serif;
                    font-weight: bold;
                    fill: black;
                    user-select: none;
                }
            </style>
            <defs>
                <circle id="sector" cx="250" cy="250" r="225" transform="rotate(120 250 250)" stroke-dashoffset="235.61944901923448" stroke-dasharray="1413.7166941554069"
                    stroke="white" stroke-width="50" fill="none" />
                <circle id="indicator" cx="250" cy="250" r="225" transform="rotate(120 250 250)" stroke-dasharray="1413.7166941554069" stroke-width="50"
                    fill="none" />
                <circle id="scale" cx="250" cy="250" r="225" transform="rotate(120 250 250)" stroke-dasharray="2 5" stroke-width="50" fill="none"
                />

                <filter xmlns="http://www.w3.org/2000/svg" id="dropshadow" height="130%">
                    <feGaussianBlur in="SourceAlpha" stdDeviation="3" />
                    <feOffset dx="2" dy="2" result="offsetblur" />
                    <feMerge>
                        <feMergeNode/>
                        <feMergeNode in="SourceGraphic" />
                    </feMerge>
                </filter>
            </defs>
            <mask id="mask">
                <use xlink:href="#sector" />
            </mask>
            <mask id="scale-mask">
                <use xlink:href="#scale" stroke="white" />
            </mask>
            <use xlink:href="#scale" mask="url(#mask)" stroke="#333333" />
            <!-- 
            stroke-dashoffset = circumference - circumference / 360 * deg
         -->
            <use xlink:href="#indicator" class="indicator" mask="url(#scale-mask)" stroke-dashoffset="1189.8782175471342" stroke="orange"
            />
            <circle cx="250" cy="250" r="200" fill="#fff" fill-opacity="1" filter="url(#dropshadow)" />
            <g transform="translate(250 250) rotate(-240)">
                <g class="meter" transform="rotate(57)">
                    <circle cx="0" cy="0" r="200" fill="#fff" fill-opacity="1" />
                    <polygon points="0,-20 20,0 0,20" style="fill:black;stroke:none;" transform="translate(180 0)" />
                </g>
            </g>
            <text class="display" x="250" y="270" text-anchor="middle">
                +18
            </text>
            <circle cx="250" cy="250" r="250" fill="white" fill-opacity="0" id="knob" />
        </svg>
    </div>



    <script>
        // P = 1413.7166941154069
        (function () {
            const knob = document.getElementById("knob");
            const meter = knob.parentElement.querySelector(".meter")
            const indicator = knob.parentElement.querySelector(".indicator");
            const display = knob.parentElement.querySelector(".display");

            const min = 23;
            const max = 35;
            const initValue = 30;


            const b = 23;
            const k = (35 - 23) / 300;

            const initAngle = (30 - b) / k;

            const circumference = Math.PI * 2 * 225;

            function rotateMeter(angle) {
                meter.setAttribute("transform", `rotate(${angle})`);
            }

            function setIndicator(angle) {
                const offset = circumference - circumference / 360 * angle;
                indicator.setAttribute("stroke-dashoffset", offset);
            }

            function mapToScales(angle) {
                return k * angle + b;
            }

            function setText(angle) {
                display.childNodes[0].textContent = "+".concat(Math.round(mapToScales(angle)));
            }

            rotateMeter(initAngle);
            setIndicator(initAngle);
            setText(initAngle);

            const { top, left, width, height } = knob.parentElement.getBoundingClientRect();

            const center = {
                x: left + width / 2,
                y: top + height / 2
            }

            let dragStart = false;
            let prevAngle;
            knob.addEventListener("mousedown", () => {
                dragStart = true;
            })

            window.addEventListener("mousemove", (e) => {
                if (dragStart) {
                    const mouseCoords = {
                        x: e.pageX,
                        y: e.pageY
                    }
                    const deltaX = center.x - mouseCoords.x;
                    const deltaY = center.y - mouseCoords.y;

                    let angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI) + 180;

                    angle = angle - 90 < 0 ? angle + 360 - 90 : angle - 90;
                    angle = angle - 30;
                    angle = angle > 300 ? 300 : angle;
                    angle = angle < 0 ? 0 : angle;

                    // if (prevAngle !== undefined) {
                    //     if (prevAngle === 0 && angle === 300) return;
                    //     if (prevAngle === 300 && angle === 0) return;
                    // }

                    rotateMeter(angle);
                    setIndicator(angle);
                    setText(angle);
                    // prevAngle = angle;
                }
            })

            window.addEventListener("mouseup", (e) => {
                if (dragStart) {
                    dragStart = false;
                }
            })
        })()


        // const uri = "http://www.w3.org/2000/svg";
        // const p = Math.PI * 2 * 225;
        // const sec = p * 300 / 360;
        // console.log("Circle circumference", p);
        // console.log("Sector circumference", sec);
        // console.log("Difference", p - sec);
        // const range = document.getElementById("test");
        // if (range) {
        //     const svg = document.createElementNS(uri, "svg");
        //     svg.setAttribute("width", "500");
        //     svg.setAttribute("height", "500");
        //     svg.setAttribute("viewBox", "0 0 500 500");
        //     const circle = document.createElementNS(uri, "circle");
        //     circle.setAttribute("cx", "250");
        //     circle.setAttribute("cy", "250");
        //     circle.setAttribute("r", "225");
        //     circle.setAttribute("stroke", "red");
        //     circle.setAttribute("stroke-width", "50");
        //     circle.setAttribute("fill", "none");
        //     svg.appendChild(circle);
        //     range.parentElement.insertBefore(svg, range);
        // }
    </script>

</body>

</html>